name: üê≥ Deploy Backend to Cloud Run

# Git ÌÉúÍ∑∏(v*.*.*) Ìë∏Ïãú ÌòπÏùÄ ÏàòÎèô Ïã§Ìñâ Î™®Îëê ÌóàÏö©
on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:

      # 1) ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2) GCP Ïù∏Ï¶ù (GCP_SA_KEYÎäî GitHub SecretsÏóê Îì±Î°ù)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3) ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ∏ÌåÖ
      - name: Set environment variables
        run: |
          echo "PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          echo "REGION=asia-northeast3"           >> $GITHUB_ENV
          echo "SERVICE_NAME=deb-backend"         >> $GITHUB_ENV

      # 4) Cloud Build Ïã§Ìñâ (BACKEND/cloudbuild.yaml Í≤ΩÎ°ú Ï£ºÏùò)
      - name: Build & Submit
        uses: google-github-actions/cloud-build@v0
        with:
          project_id: ${{ env.PROJECT_ID }}
          config: BACKEND/cloudbuild.yaml

      # 5) Cloud Run Î∞∞Ìè¨
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v1
        with:
          project_id: ${{ env.PROJECT_ID }}
          service: ${{ env.SERVICE_NAME }}
          image: gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          allow-unauthenticated: true
